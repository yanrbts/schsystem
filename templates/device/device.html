{% extends "layouts/base.html" %} {# 确保继承正确的布局文件 #}

{% block title %}设备配置与状态{% endblock %}

{% block content %}

<div class="pc-container">
  <div class="pc-content">
    <!-- [ breadcrumb ] start -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="mb-0">设备信息</h5>
            </div>
          </div>
          <div class="col-md-12">
            <ul class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="{{ url_for('home_blueprint.index') }}">Home</a></li>
              <li class="breadcrumb-item"><a href="javascript: void(0)">Apps</a></li>
              <li class="breadcrumb-item" aria-current="page">设备信息</li>
            </ul>
          </div>
          {# 渲染 flash 消息 #}
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="col-md-12 mt-3">
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}" role="alert">
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
    <!-- [ breadcrumb ] end -->

    <!-- [ Main Content ] start -->
    <div class="row">
      {% if form or raw_data %}
      
      {# 将表单字段包裹在 <form> 标签内，并将 form 本身设置为 row #}
      <form method="POST" class="row"> {# form 标签现在是 row #}
        {{ form.csrf_token }} {# 必须包含 CSRF 令牌 #}

        {# --- 左侧列：基本信息与网络配置卡片 --- #}
        <div class="col-md-12 col-xl-6"> {# 占用 6 列 #}
          <div class="card">
            <div class="card-header">
              <h5>基本信息与网络配置</h5>
            </div>
            <div class="card-body">
              {# 只读字段：ip - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center"> {# 使用 Flexbox 布局 #}
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.ip.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.ip.data | default('N/A') }}</p>
              </div>
              {# 只读字段：selfId - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.selfId.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.selfId.data | default('N/A') }}</p>
              </div>
              {# 只读字段：nodeNumber - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.nodeNumber.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.nodeNumber.data | default('N/A') }}</p>
              </div>
              {# 可修改字段：silenced - 显示为复选框 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.silenced.label }}:</strong></label>
                {{ form.silenced(class_="form-check-input me-2") }}
                <span class="form-check-label-inline">{{ "是" if form.silenced.data else "否" }}</span>
              </div>
              {# 只读字段：configUpdated - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.configUpdated.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ "是" if form.configUpdated.data else "否" }}</p>
              </div>
              {# 可修改字段：operatingFreq #}
              <div class="mb-3 d-flex align-items-center">
                <label for="{{ form.operatingFreq.id }}" class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.operatingFreq.label }}:</strong></label>
                {{ form.operatingFreq(class_="form-control form-control-compact") }} {# 使用紧凑型样式 #}
              </div>
              {# 只读字段：operatingCtrlFreqMask - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.operatingCtrlFreqMask.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.operatingCtrlFreqMask.data | default('N/A') }}</p>
              </div>
              
              <hr class="my-3">
              
              {#<h6 class="mb-3">网络配置详情</h6>#}
              {# 可修改字段：nwMask #}
              <div class="mb-3 d-flex align-items-center">
                <label for="{{ form.nwMask.id }}" class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.nwMask.label }}:</strong></label>
                {{ form.nwMask(class_="form-control form-control-compact") }} {# 使用紧凑型样式 #}
              </div>
              {# 可修改字段：dnsServer #}
              <div class="mb-3 d-flex align-items-center">
                <label for="{{ form.dnsServer.id }}" class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.dnsServer.label }}:</strong></label>
                {{ form.dnsServer(class_="form-control form-control-compact") }} {# 使用紧凑型样式 #}
              </div>
              {# 可修改字段：gateway #}
              <div class="mb-3 d-flex align-items-center">
                <label for="{{ form.gateway.id }}" class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.gateway.label }}:</strong></label>
                {{ form.gateway(class_="form-control form-control-compact") }} {# 使用紧凑型样式 #}
              </div>

              <hr class="my-3">

              {#<h6 class="mb-3">噪音 RSSI 详情</h6> #}
              {# 噪音 RSSI 下拉菜单 - 可选择 #}
              <div class="mb-3 d-flex align-items-center">
                <label for="{{ form.noiseRssiSelect.id }}" class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.noiseRssiSelect.label }}:</strong></label>
                {{ form.noiseRssiSelect(class_="form-select form-control-compact") }} {# 直接渲染 SelectField #}
              </div>
            </div>
          </div>
        </div>

        {# --- 右侧列：设备状态卡片 和 其他状态信息卡片 --- #}
        <div class="col-md-12 col-xl-6"> {# 占用 6 列 #}
          {# --- 设备状态卡片 (只读显示) --- #}
          <div class="card">
            <div class="card-header">
              <h5>设备状态</h5>
            </div>
            <div class="card-body">
              {# 只读字段：batteryLevel - 显示为纯文本和进度条 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.batteryLevel.label }}:</strong></label>
                <div class="flex-grow-1"> {# 使用 flex-grow-1 让进度条容器填充剩余空间 #}
                  <p class="mb-0">{{ form.batteryLevel.data | default(0) | round(2) }}%</p>
                  <div class="progress mt-1" style="height: 7px;">
                    <div class="progress-bar bg-brand-color-1" role="progressbar" style="width: {{ form.batteryLevel.data | default(0) }}%;" aria-valuenow="{{ form.batteryLevel.data | default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>

              {# 只读字段：temp - 显示为纯文本和进度条 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.temp.label }}:</strong></label>
                <div class="flex-grow-1"> {# 使用 flex-grow-1 让进度条容器填充剩余空间 #}
                  <p class="mb-0">{{ form.temp.data | default(0) | round(2) }} °C</p>
                  <div class="progress mt-1" style="height: 7px;">
                    <div class="progress-bar bg-brand-color-2" role="progressbar" style="width: {{ (form.temp.data / 100 * 100) | default(0) }}%;" aria-valuenow="{{ (form.temp.data / 100 * 100) | default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {# --- 其他状态信息卡片 (直接使用 raw_data 渲染) - 移动到设备状态卡片下方 #}
          <div class="card">
            <div class="card-header">
              <h5>其他状态信息</h5>
            </div>
            <div class="card-body">
              {# 使用 d-flex align-items-center 和 text-nowrap 优化布局 #}
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">正在讲话的节点:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.speakingNodes %}{{ raw_data.speakingNodes | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">链路质量:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.linkQuality %}
                        {% for link in raw_data.linkQuality %}
                            [{{ link | join(', ') }}]{% if not loop.last %}; {% endif %}
                        {% endfor %}
                    {% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">异构链路节点:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.heterogeneousLinkNodes %}{{ raw_data.heterogeneousLinkNodes | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">节点 RSSI:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.nodesRssi %}{{ raw_data.nodesRssi | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">查询路由:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.queryRoutes %}{{ raw_data.queryRoutes | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">传输延迟:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.transmissionDelay %}{{ raw_data.transmissionDelay | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
              <div class="mb-2 d-flex align-items-center">
                <strong class="me-2 mb-0 field-label-fixed-width">设备列表:</strong> 
                <p class="mb-0 text-nowrap overflow-hidden text-truncate flex-grow-1">
                    {% if raw_data.devices %}{{ raw_data.devices | join(', ') }}{% else %}无{% endif %}
                </p>
              </div>
            </div>
          </div>
        </div>
        
        {# --- 提交按钮 --- #}
        <div class="col-12 mt-4 text-start">
            {# 替换为硬编码的按钮格式 #}
            <button type="submit" name="save" class="btn btn-primary shadow px-sm-4">保存修改</button>
        </div>
      </form>

      {% else %}
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <p class="text-center text-muted">未能加载设备配置和状态数据。</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    <!-- [ Main Content ] end -->
  </div>
</div>

{% endblock content %}

{% block extra_js %}
{# 如果 device.html 需要特定的 JS 脚本，可以在这里添加 #}
{% endblock extra_js %}
