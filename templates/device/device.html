{% extends "layouts/base.html" %} {# 确保继承正确的布局文件 #}

{% block title %}设备配置与状态{% endblock %}

{% block content %}

<div class="pc-container">
  <div class="pc-content">
    <!-- [ breadcrumb ] start -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="mb-0">设备信息</h5>
            </div>
          </div>
          <div class="col-md-12">
            <ul class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="{{ url_for('home_blueprint.index') }}">Home</a></li>
              <li class="breadcrumb-item"><a href="javascript: void(0)">Apps</a></li>
              <li class="breadcrumb-item" aria-current="page">设备信息</li>
            </ul>
          </div>
          {# 渲染 flash 消息 #}
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="col-md-12 mt-3">
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}" role="alert">
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
    <!-- [ breadcrumb ] end -->

    <!-- [ Main Content ] start -->
    <div class="row">
      {% if form or raw_data %}
      
      {# 将表单字段包裹在 <form> 标签内，并将 form 本身设置为 row #}
      <form method="POST" class="row"> {# form 标签现在是 row #}
        {{ form.csrf_token }} {# 必须包含 CSRF 令牌 #}

        {# --- 左侧列：基本信息与网络配置卡片 --- #}
        <div class="col-md-12 col-xl-6"> {# 占用 6 列 #}
          <div class="card">
            <div class="card-header">
              <h5>基本信息与网络配置</h5>
            </div>
            <div class="card-body">
              <div class="mb-3 d-flex align-items-center"> {# 使用 Flexbox 布局 #}
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.name.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.name.data | default('N/A') }}</p>
              </div>
              {# 只读字段：ip - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center"> {# 使用 Flexbox 布局 #}
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.ip.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.ip.data | default('N/A') }}</p>
              </div>
              {# 只读字段：selfId - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.selfId.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.selfId.data | default('N/A') }}</p>
              </div>
              {# 只读字段：nodeNumber - 显示为纯文本 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.nodeNumber.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.nodeNumber.data | default('N/A') }}</p>
              </div>
               <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width">
                    <strong>{{ form.freq.label }}:</strong>
                </label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ (form.freq.data | default(0) / 1000000) | round(2) }} MHz</p>
              </div>
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width">
                    <strong>{{ form.span.label }}:</strong>
                </label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ form.span.data }}</p>
              </div>
               <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.silenced.label }}:</strong></label>
                <p class="mb-0 text-nowrap overflow-hidden text-truncate">{{ "是" if form.silenced.data else "否" }}</p>
              </div>
            </div>
          </div>
        </div>

        {# --- 右侧列：设备状态卡片 和 其他状态信息卡片 --- #}
        <div class="col-md-12 col-xl-6"> {# 占用 6 列 #}
          {# --- 设备状态卡片 (只读显示) --- #}
          <div class="card">
            <div class="card-header">
              <h5>设备状态</h5>
            </div>
            <div class="card-body">
              {# 只读字段：batteryLevel - 显示为纯文本和进度条 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.batteryLevel.label }}:</strong></label>
                <div class="flex-grow-1"> {# 使用 flex-grow-1 让进度条容器填充剩余空间 #}
                  <p class="mb-0">{{ form.batteryLevel.data | default(0) | round(2) }}%</p>
                  <div class="progress mt-1" style="height: 7px;">
                    <div class="progress-bar bg-brand-color-1" role="progressbar" style="width: {{ form.batteryLevel.data | default(0) }}%;" aria-valuenow="{{ form.batteryLevel.data | default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>

              {# 只读字段：temp - 显示为纯文本和进度条 #}
              <div class="mb-3 d-flex align-items-center">
                <label class="me-2 mb-0 field-label-fixed-width"><strong>{{ form.temp.label }}:</strong></label>
                <div class="flex-grow-1"> {# 使用 flex-grow-1 让进度条容器填充剩余空间 #}
                  <p class="mb-0">{{ form.temp.data | default(0) | round(2) }} °C</p>
                  <div class="progress mt-1" style="height: 7px;">
                    <div class="progress-bar bg-brand-color-2" role="progressbar" style="width: {{ (form.temp.data / 100 * 100) | default(0) }}%;" aria-valuenow="{{ (form.temp.data / 100 * 100) | default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {# --- 提交按钮 --- #}
        <div class="col-12 mt-4 text-start">
            {# 按钮名称改为 'save'，文本改为 '保存修改' #}
            <button type="submit" name="save" class="btn btn-primary shadow px-sm-4">修改配置</button>
        </div>
      </form>

      {% else %}
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <p class="text-center text-muted">未能加载设备配置和状态数据。</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    <!-- [ Main Content ] end -->
  </div>
</div>

{% endblock content %}

{% block extra_js %}
{# 可以在这里添加 device.html 特有的 JavaScript #}
{% endblock extra_js %}
